<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>📝 Expression de Besoin (PER) - UFR SES</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/auth.js"></script>
  <script src="js/main.js"></script>
</head>
<body>

  <!-- 🔐 Vérification d'authentification -->
  <script>
    const user = checkAuth();
  </script>

  <header>
    <h1>📝 Expression de Besoin (PER)</h1>
    <a href="index.html" class="back">← Retour au menu</a>
    <a href="login.html" id="logoutBtn" style="font-size: 14px; color: #900;">🔐 Déconnexion</a>
  </header>

  <main>
    <!-- Formulaire PER -->
    <section class="card" id="formSection">
      <h2>Déposer une demande</h2>
      <form id="formPER">
        <label>Nom du demandeur :</label>
        <input type="text" id="demandeur" required />

        <label>Service / Département :</label>
        <select id="service">
          <option value="MIO">MIO</option>
          <option value="Droit">Droit</option>
          <option value="Sociologie">Sociologie</option>
          <option value="Tourisme">Tourisme</option>
          <option value="Économie-Gestion">Économie-Gestion</option>
        </select>

        <label>Objet de la demande :</label>
        <textarea id="objet" required></textarea>

        <label>Montant estimé (FCFA) :</label>
        <input type="number" id="montant" required />

        <button type="submit">Soumettre la demande</button>
      </form>

      <div id="alerte" style="margin-top: 15px; font-weight: bold;"></div>
    </section>

    <!-- Liste des demandes -->
    <section class="card">
      <h2>Liste des demandes en cours</h2>
      <ul id="listePER">
        <li>Aucune demande enregistrée.</li>
      </ul>
    </section>
  </main>

  <!-- 🔒 Protection par rôle -->
  <script>
    const rolesAutorises = ["comptable"];

    if (!rolesAutorises.includes(user.role)) {
      // Masquer le formulaire
      document.getElementById("formSection").style.display = "none";

      // Désactiver tout champ
      document.querySelectorAll("input, textarea, select, button").forEach(el => {
        el.disabled = true;
        el.style.opacity = "0.6";
      });

      // Bloquer soumission
      document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", function(e) {
          e.preventDefault();
          alert(`❌ Impossible : seul le comptable peut déposer un PER.`);
        });
      });

      // Message lecture seule
      const notice = document.createElement("div");
      notice.textContent = `👁️ Lecture seule – Vous êtes connecté(e) en tant que ${user.role}`;
      notice.style = "background: #fff3cd; color: #856404; padding: 12px; text-align: center; font-weight: bold; margin: 15px 20px; border-radius: 5px;";
      document.querySelector("main").prepend(notice);
    }

    // Gestion déconnexion
    document.getElementById("logoutBtn").addEventListener("click", function(e) {
      if (confirm("Voulez-vous vous déconnecter ?")) {
        localStorage.removeItem("user");
      }
    });
  </script>

  <!-- 📥 Logique métier -->
  <script src="js/per.js"></script>

</body>
</html>